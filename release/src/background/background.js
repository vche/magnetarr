(()=>{let t={Unknown:null,Movie:"movie",Serie:"serie"};class e{constructor(t,e=0){this.name=t,this.default_port=e,this.setConfig()}setConfig(t=null){null==t?t={configuration:{auth:{}},preferences:{}}:(void 0===t.configuration?t.configuration={auth:{}}:void 0===t.configuration.auth&&(t.configuration.auth={}),void 0===t.preferences&&(t.preferences={})),this.enabled=t.enabled||!1,this.host=t.configuration.host||"http://127.0.0.1",this.port=t.configuration.port||this.default_port,this.apikey=t.configuration.apikey||"",this.user=t.configuration.auth.user||"",this.password=t.configuration.auth.password||"",this.monitored=t.preferences.monitored||!0,this.profileid=t.preferences.qualityProfileId||"1",this.auxinfo=t.preferences.auxInfo||"1"}getConfig(){return{enabled:this.enabled,configuration:{host:this.host,port:this.port,apikey:this.apikey,auth:{user:this.user,pass:this.password}},preferences:{monitored:this.monitored,qualityProfileId:this.profileid,auxInfo:this.auxinfo}}}loadConfig(t=null){let e={};e[this.name]=this.getConfig(),chrome.storage.sync.get(e,e=>{this.setConfig(e[this.name]),console.debug(`Loaded ${this.name} config: ${JSON.stringify(this.getConfig())}`),t&&t(e)})}saveConfig(t){let e={};e[this.name]=this.getConfig(),console.debug(`Saved ${this.name} config: ${JSON.stringify(this.getConfig())}`),chrome.storage.sync.set(e,()=>{t()})}getUrl(){return(RegExp("https{0,1}://").exec(this.host)||(this.host="http://"+this.host),""===this.port)?this.host:this.host+":"+this.port}async get(t,e=null,i=null){try{var r=this.getUrl()+t;i&&(r=r+"?"+i);let n={"X-Api-Key":this.apikey};this.user&&this.password&&(n.Authorization="Basic "+btoa(this.user+":"+this.password));var s=e;null!=e&&"string"!=typeof e&&(s=JSON.stringify(e));let o=await fetch(r,{method:"get",body:s,headers:n});if(o.status>=400)throw Error(`${o.status} (${o.statusText})`);return e=await o.json(),console.debug(`Request to ${r}: ${o.status} ${JSON.stringify(e)}`),e}catch(t){throw console.log(`Error querying endpoint ${r}: ${t}`),t}}getLogo(t="48"){return`./img/${this.name}/${this.name}-${t}.png`}itemUrlPath(){return""}checkItemId(t,e){return False}async itemExists(t=null,e=null){let i=await this.get(this.itemUrlPath());for(var r=0;r<i.length;r++){let s=i[r];if(t&&this.checkItemId(t,s)||e&&e===s.titleSlug)return s.titleSlug}}async lookupItem(t){console.log("yp pipo trouve: "+await this.itemExists(t))}}let i={};i[t.Movie]=new class extends e{constructor(){super("radarr",7878)}itemUrlPath(){return"/api/v3/movie"}checkItemId(t,e){return t===e.imdbId}},i[t.Serie]=new class extends e{constructor(){super("sonarr",8989)}itemUrlPath(){return"/api/v3/series"}checkItemId(t,e){return e.tvdbId&&t===e.tvdbId.toString()}};class r{static get name(){return""}constructor(t){this.name=s.name}urlMatch(t){return!1}itemFromUrl(e){return{itemid:0,itemtype:t.Unknown}}}class s extends r{static get name(){return"Imdb"}constructor(t){super(t),this.idRegex=RegExp("/tt\\d{1,8}"),this.xmlparser=new DOMParser}urlMatch(t){return!!t.match(/\/\/www\.imdb.com\/.+\/tt\d{7,8}\//)}imdbIdFromUrl(t){let e=this.idRegex.exec(t);return e?e[0].slice(1):""}async tvdbidFromImdbid(t){let e="http://thetvdb.com/api/GetSeriesByRemoteID.php?imdbid="+t;try{let t=await fetch(e,{method:"get",headers:{"Content-Type":"application/xml"}});if(t.status>=400)throw Error(`${t.status} (${t.statusText})`);let i=await t.text();console.debug(`Request to ${e}: ${t.status} ${i}`);let r=this.xmlparser.parseFromString(i,"application/xml");if(r.querySelector("parsererror"))console.log("error while parsing response: "+i);else{let t=r.getElementsByTagName("seriesid");if(t.length>0)return t[0].innerHTML}}catch(t){console.log(`Error querying endpoint ${e}: ${t}`)}return null}async itemFromUrl(e){let i=this.imdbIdFromUrl(e);if(!i)return{itemid:null,itemtype:t.Unknown};let r=await this.tvdbidFromImdbid(i);return(console.debug("imdb id "+i+" // tvdb id "+r),r)?{itemid:r,itemtype:t.Serie}:{itemid:i,itemtype:t.Movie}}}let n={};function o(t){chrome.tabs.query({active:!0,currentWindow:!0},function(e){e[0]&&function(t){for(let[e,i]of Object.entries(n))if(i.urlMatch(t))return i;return null}(e[0].url)?chrome.action.enable(t.tabId):chrome.action.disable(t.tabId)})}n[s.name]=new s,chrome.tabs.onActivated.addListener(o),chrome.webNavigation.onCommitted.addListener(o)})();
//# sourceMappingURL=background.js.map
