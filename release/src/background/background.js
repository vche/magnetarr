(()=>{let t={Unknown:null,Movie:"movie",Serie:"serie"};class e{constructor(e=null,i=t.Unknown,r=null,s=null,n={}){this.provider=null,this.server=null,this.itemid=e,this.itemtype=i,this.itemslug=r,this.properties=n,this.exists=s}getPosterUrl(){if(this.properties&&this.properties.images){for(var t=0;t<this.properties.images.length;t++)if("poster"===this.properties.images[t].coverType)return this.properties.images[t].remoteUrl}}}class i{constructor(t,e=0){this.name=t,this.default_port=e,this.setConfig()}setConfig(t=null){null==t?t={configuration:{auth:{}},preferences:{}}:(void 0===t.configuration?t.configuration={auth:{}}:void 0===t.configuration.auth&&(t.configuration.auth={}),void 0===t.preferences&&(t.preferences={})),this.enabled=t.enabled||!1,this.host=t.configuration.host||"http://127.0.0.1",this.port=t.configuration.port||this.default_port,this.apikey=t.configuration.apikey||"",this.user=t.configuration.auth.user||"",this.password=t.configuration.auth.password||"",this.monitored=t.preferences.monitored||!0,this.profileid=t.preferences.qualityProfileId||"",this.auxinfo=t.preferences.auxInfo||"",this.folder=t.preferences.folder||"",this.profiles=[],this.folders=[]}getConfig(){return{enabled:this.enabled,configuration:{host:this.host,port:this.port,apikey:this.apikey,auth:{user:this.user,pass:this.password}},preferences:{monitored:this.monitored,qualityProfileId:this.profileid,auxInfo:this.auxinfo,folder:this.folder}}}async loadConfig(t=!1,e=!1){let i={};i[this.name]=this.getConfig();let r=await chrome.storage.sync.get(i);return this.setConfig(r[this.name]),console.debug(`Loaded ${this.name} config: ${JSON.stringify(this.getConfig())}`),t&&(this.profiles=await this.getProfiles()),e&&(this.folders=await this.getFolders()),r}async saveConfig(){let t={};t[this.name]=this.getConfig(),console.debug(`Saved ${this.name} config: ${JSON.stringify(this.getConfig())}`),await chrome.storage.sync.set(t)}getUrl(){return(RegExp("https{0,1}://").exec(this.host)||(this.host="http://"+this.host),""===this.port)?this.host:this.host+":"+this.port}async get(t,e=null,i=null){try{var r=this.getUrl()+t;i&&(r=r+"?"+i);let n={"X-Api-Key":this.apikey};this.user&&this.password&&(n.Authorization="Basic "+btoa(this.user+":"+this.password));var s=e;null!=e&&"string"!=typeof e&&(s=JSON.stringify(e));let o=await fetch(r,{method:"get",body:s,headers:n});if(o.status>=400)throw Error(`${o.status} (${o.statusText})`);return e=await o.json(),console.debug(`Request to ${r}: ${o.status} ${JSON.stringify(e)}`),e}catch(t){throw console.log(`Error querying endpoint ${r}: ${t}`),t}}getLogo(t="48"){return`/img/${this.name}/${this.name}-${t}.png`}async itemExists(t){let e=await this.getItemList();for(var i=0;i<e.length;i++){let r=e[i];if(t.itemid&&this.checkItemId(t.itemid,r)||t.itemslug&&t.itemslug===r.titleSlug)return r.titleSlug}return null}async getItemInfo(t){let[e,i]=await Promise.all([this.itemExists(t),this.lookupItem(t)]);return t.itemslug=e,t.exists=!!t.itemslug,0==i.length&&(t.properties=null),i.length>0&&(t.properties=i[0],i.length>1&&console.log("Warning, several results found for this item")),t}async getProfiles(){return await this.get(this.getProfileUrlPath())}async getFolders(){let t=await this.get(this.getFolderUrlPath()),e=[];for(let i=0;i<t.length;i++)e.push({name:t[i].path,id:t[i].path});return e}async getItemList(){return[]}async lookupItem(t){return{}}getAuxInfoValues(){return[]}getItemUrl(t){return this.getUrl()+"/"+t.itemslug}checkItemId(t,e){return False}getProfileUrlPath(){return"/profiles"}getFolderUrlPath(){return"/folders"}}let r={};r[t.Movie]=new class extends i{constructor(){super("radarr",7878)}async getItemList(){return await this.get("/api/v3/movie")}async lookupItem(t){return await this.get("/api/v3/movie/lookup",null,"term=imdb%3A%20"+t.itemid)}checkItemId(t,e){return t===e.imdbId}getItemUrl(t){return this.getUrl()+"/movies/"+t.itemslug}getProfileUrlPath(){return"/api/v3/qualityProfile"}getFolderUrlPath(){return"/api/v3/rootfolder"}getAuxInfoValues(){return[{name:"Announced",id:"announced"},{name:"In Cinemas",id:"inCinemas"},{name:"Physical/Web",id:"released"},{name:"Pre DB/Web",id:"preDB"}]}},r[t.Serie]=new class extends i{constructor(){super("sonarr",8989)}async getItemList(){return await this.get("/api/v3/series")}async lookupItem(t){return await this.get("/api/v3/series/lookup",null,"term=tvdb%3A%20"+t.itemid)}checkItemId(t,e){return e.tvdbId&&t===e.tvdbId.toString()}getItemUrl(t){return this.getUrl()+"/series/"+t.itemslug}getProfileUrlPath(){return"/api/v3/qualityProfile"}getFolderUrlPath(){return"/api/v3/rootfolder"}getAuxInfoValues(){return[{name:"Standard",id:"standard"},{name:"Daily",id:"daily"},{name:"Anime",id:"anime"}]}};class s{static get name(){return""}constructor(t){this.name=n.name}urlMatch(t){return!1}itemFromUrl(e){return{itemid:0,itemtype:t.Unknown}}}class n extends s{static get name(){return"Imdb"}constructor(t){super(t),this.idRegex=RegExp("/tt\\d{1,8}"),this.xmlparser=new DOMParser}_imdbIdFromUrl(t){let e=this.idRegex.exec(t);return e?e[0].slice(1):""}urlMatch(t){return!!t.match(/\/\/www\.imdb.com\/.+\/tt\d{7,8}\//)}async tvdbidFromImdbid(t){let e="http://thetvdb.com/api/GetSeriesByRemoteID.php?imdbid="+t;try{let t=await fetch(e,{method:"get",headers:{"Content-Type":"application/xml"}});if(t.status>=400)throw Error(`${t.status} (${t.statusText})`);let i=await t.text();console.debug(`Request to ${e}: ${t.status} ${i}`);let r=this.xmlparser.parseFromString(i,"application/xml");if(r.querySelector("parsererror"))console.log("error while parsing response: "+i);else{let t=r.getElementsByTagName("seriesid");if(t.length>0)return t[0].innerHTML}}catch(t){console.log(`Error querying endpoint ${e}: ${t}`)}return null}async itemFromUrl(i){let r=this._imdbIdFromUrl(i);if(!r)return new e;let s=await this.tvdbidFromImdbid(r);return(console.debug("imdb id "+r+" // tvdb id "+s),s)?new e(s,t.Serie):new e(r,t.Movie)}}let o={};function a(t){chrome.tabs.query({active:!0,currentWindow:!0},function(e){e[0]&&function(t){for(let[e,i]of Object.entries(o))if(i.urlMatch(t))return i;return null}(e[0].url)?chrome.action.enable(t.tabId):chrome.action.disable(t.tabId)})}o[n.name]=new n,chrome.tabs.onActivated.addListener(a),chrome.webNavigation.onCommitted.addListener(a)})();
//# sourceMappingURL=background.js.map
